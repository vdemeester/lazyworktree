name: goreleaser

on:
  push:
    # run only against tags
    tags:
      - "*"

permissions:
  contents: write
  # packages: write
  issues: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Fetch all tags
        run: git fetch --force --tags
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AUR_PRIVATE_KEY: ${{ secrets.AUR_PRIVATE_KEY }}
      - name: Update release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euxo pipefail

          if [ -z "${GEMINI_API_KEY}" ]; then
            echo "GEMINI_API_KEY is required"
            exit 1
          fi

          previous_tag="$(git tag --sort=-version:refname | awk -v tag="${TAG}" '$0 != tag { print; exit }')"
          release_date="$(date -u +%Y-%m-%d)"
          model="gemini-3.1-pro-preview"
          range="${TAG}"

          if [ -n "${previous_tag}" ]; then
            range="${previous_tag}..${TAG}"
          fi

          git log --patch --no-color "${range}" >/tmp/release-commits.txt
          if [ ! -s /tmp/release-commits.txt ]; then
            echo "- None." >/tmp/release-commits.txt
          fi

          git log --pretty='%s%n%b' "${range}" | grep -Eo '#[0-9]+' | sort -u | sed 's/^/- /' >/tmp/release-prs.txt || true
          if [ ! -s /tmp/release-prs.txt ]; then
            echo "- None." >/tmp/release-prs.txt
          fi

          git log --pretty='- %s%n%b' "${range}" | grep -Ei 'breaking change|breaking-change|!:' >/tmp/release-breaking.txt || true
          if [ ! -s /tmp/release-breaking.txt ]; then
            echo "None" >/tmp/release-breaking.txt
          fi

          cat >/tmp/release-prompt.txt <<EOF
          You are generating GitHub release notes for a software project.

          GOAL
          Write clear, concise, professional GitHub release notes suitable for a public open-source release.

          Changes:
          $(cat /tmp/release-commits.txt)

          Pull Requests:
          $(cat /tmp/release-prs.txt)

          Breaking Changes:
          $(cat /tmp/release-breaking.txt)

          INSTRUCTIONS

          - Group changes into logical sections:
            - ðŸš€ Features
            - ðŸ› Bug Fixes
            - âš¡ Performance Improvements
            - ðŸ§¹ Maintenance / Refactoring
            - ðŸ“¦ Dependencies
            - ðŸ’¥ Breaking Changes (only if applicable)
          - Convert raw commits into user-facing language.
          - Merge duplicate or noisy commits into one clean bullet.
          - Mention PR numbers when available.
          - Do not invent changes.
          - Keep tone neutral and professional.
          - Keep it scannable (bullets, short sections).

          OUTPUT FORMAT (Markdown)

          {{1-2 sentence summary based on Highlights or major changes}}

          ### ðŸš€ Features

          - ...

          ### ðŸ› Bug Fixes

          - ...

          ### âš¡ Performance Improvements

          - ...

          ### ðŸ§¹ Maintenance

          - ...

          ### ðŸ“¦ Dependencies

          - ...

          ### ðŸ’¥ Breaking Changes

          - ...

          ### Contributors

          - @user1
          - @user2

          Output only the final Markdown release notes, with no code fences.
          EOF

          jq -n --rawfile prompt /tmp/release-prompt.txt '{contents:[{parts:[{text:$prompt}]}]}' >/tmp/gemini-request.json

          curl -fsS "https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d @/tmp/gemini-request.json >/tmp/gemini-response.json

          if ! jq -er '.candidates[0].content.parts | map(.text // "") | join("") | select(length > 0 and . != "null")' /tmp/gemini-response.json >/tmp/gh-release.md; then
            echo "Gemini returned invalid release notes"
            cat /tmp/gemini-response.json
            exit 1
          fi

          gh release edit "${TAG}" --notes-file /tmp/gh-release.md
